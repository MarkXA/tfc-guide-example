trigger:
- master

variables:
- group: RASP

pool:
  vmImage: ubuntu-latest

steps:
- task: TerraformInstaller@0
  inputs:
    terraformVersion: 'latest'

- script: |
    cd $(Build.SourcesDirectory)
    sed -i 's/STATEFILE/"$(stateFile)"/' ./backend.tf
    terraform init
  displayName: 'terraform init'

- script: |
    cd $(Build.SourcesDirectory)
    terraform apply -target="module.aksCluster" -auto-approve
  displayName: 'terraform apply aksCluster'

- script: |
    cd $(Build.SourcesDirectory)
    terraform apply -auto-approve
  displayName: 'terraform apply'
